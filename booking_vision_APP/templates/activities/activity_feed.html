{% extends 'base.html' %}
{% load static %}

{% block title %}Activity Feed - Booking Vision{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'booking_vision_APP:dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item active">Activity Feed</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 text-primary-blue">
                    <i class="fas fa-stream me-2"></i>Activity Feed
                </h1>
                {% if activities %}
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="markAllAsRead()" 
                            {% if not stats.unread %}disabled{% endif %}>
                        <i class="fas fa-check-double me-2"></i>Mark All Read
                        {% if stats.unread %}<span class="badge bg-danger ms-1">{{ stats.unread }}</span>{% endif %}
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#preferencesModal">
                        <i class="fas fa-cog me-2"></i>Preferences
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if activities %}
        <!-- Activity Stats - Only show when there are activities -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card {% if not stats.unread %}stats-card-muted{% endif %}">
                    <h4 class="{% if stats.unread %}text-primary{% else %}text-muted{% endif %}">
                        {{ stats.unread|default:0 }}
                    </h4>
                    <p>Unread</p>
                    {% if not stats.unread %}
                        <small class="text-muted">All caught up!</small>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card {% if not stats.important %}stats-card-muted{% endif %}">
                    <h4 class="{% if stats.important %}text-warning{% else %}text-muted{% endif %}">
                        {{ stats.important|default:0 }}
                    </h4>
                    <p>Important</p>
                    {% if not stats.important %}
                        <small class="text-muted">No urgent items</small>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card {% if not stats.today %}stats-card-muted{% endif %}">
                    <h4 class="{% if stats.today %}text-info{% else %}text-muted{% endif %}">
                        {{ stats.today|default:0 }}
                    </h4>
                    <p>Today</p>
                    {% if not stats.today %}
                        <small class="text-muted">Quiet day so far</small>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h4 class="text-success">{{ stats.total|default:0 }}</h4>
                    <p>Total Activities</p>
                    {% if stats.total %}
                        <small class="text-muted">Since account creation</small>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Filters - Only show when there are activities -->
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>Filters
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Activities ({{ stats.total }})</option>
                                <option value="unread">Unread Only ({{ stats.unread }})</option>
                                <option value="important">Important Only ({{ stats.important }})</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">All Types</option>
                                {% for value, label in activity_types %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateFilter">
                                <option value="">All Time</option>
                                <option value="today">Today ({{ stats.today }})</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                        
                        {% if request.GET %}
                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear Filters
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="exportActivities()">
                                <i class="fas fa-download me-2"></i>Export Activities
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="refreshActivities()">
                                <i class="fas fa-sync me-2"></i>Refresh Feed
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity List -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>Recent Activities
                            <span class="badge bg-primary ms-2">{{ activities|length }}</span>
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary" for="listView">
                                <i class="fas fa-list"></i>
                            </label>
                            <input type="radio" class="btn-check" name="viewMode" id="compactView" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="compactView">
                                <i class="fas fa-compress"></i>
                            </label>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="activity-list" id="activityList">
                            {% for activity in activities %}
                            <div class="activity-item {% if not activity.is_read %}unread{% endif %}" 
                                 data-activity-id="{{ activity.id }}"
                                 data-type="{{ activity.type }}"
                                 data-date="{{ activity.created_at|date:'Y-m-d' }}">
                                <div class="activity-icon bg-{{ activity.color|default:'secondary' }} text-white">
                                    <i class="fas fa-{{ activity.icon|default:'bell' }}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="mb-1">
                                            {{ activity.title }}
                                            {% if activity.is_important %}
                                            <span class="badge bg-warning ms-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Important
                                            </span>
                                            {% endif %}
                                            {% if not activity.is_read %}
                                            <span class="badge bg-primary ms-1">New</span>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ activity.created_at|timesince }} ago
                                        </small>
                                    </div>
                                    <p class="mb-1 text-muted">{{ activity.description }}</p>
                                    {% if activity.details %}
                                    <div class="activity-details mt-2">
                                        {% if activity.property %}
                                        <span class="badge bg-light text-dark me-2">
                                            <i class="fas fa-home me-1"></i>{{ activity.property.name }}
                                        </span>
                                        {% endif %}
                                        {% if activity.channel %}
                                        <span class="badge bg-light text-dark me-2">
                                            <i class="fas fa-link me-1"></i>{{ activity.channel.name }}
                                        </span>
                                        {% endif %}
                                        {% if activity.guest_name %}
                                        <span class="badge bg-light text-dark me-2">
                                            <i class="fas fa-user me-1"></i>{{ activity.guest_name }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="activity-actions">
                                    {% if not activity.is_read %}
                                    <button class="btn btn-sm btn-outline-primary me-1" 
                                            onclick="markAsRead({{ activity.id }})"
                                            title="Mark as read">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                    {% if activity.action_url %}
                                    <a href="{{ activity.action_url }}" class="btn btn-sm btn-outline-secondary"
                                       title="View details">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    {% endif %}
                                    <div class="dropdown d-inline-block">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                data-bs-toggle="dropdown" title="More options">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            {% if not activity.is_important %}
                                            <li><a class="dropdown-item" href="#" onclick="markImportant({{ activity.id }})">
                                                <i class="fas fa-star me-2"></i>Mark Important
                                            </a></li>
                                            {% endif %}
                                            <li><a class="dropdown-item" href="#" onclick="archiveActivity({{ activity.id }})">
                                                <i class="fas fa-archive me-2"></i>Archive
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteActivity({{ activity.id }})">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Load More Button -->
                        {% if has_more_activities %}
                        <div class="text-center p-3 border-top">
                            <button class="btn btn-outline-primary" onclick="loadMoreActivities()">
                                <i class="fas fa-chevron-down me-2"></i>Load More Activities
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Enhanced Empty State for Activities -->
        <div class="row">
            <div class="col-12">
                {% if not user_has_channels %}
                    <!-- No channels connected -->
                    <div class="empty-state-container">
                        <div class="empty-state-card channels-empty">
                            <div class="empty-state-icon">
                                <i class="fas fa-stream"></i>
                            </div>
                            <h4 class="empty-state-title">Connect Channels to See Activities</h4>
                            <p class="empty-state-description">
                                Your activity feed will populate once you connect your booking channels. 
                                Activities include new bookings, guest messages, payment notifications, and system updates.
                            </p>
                            <div class="empty-state-features">
                                <div class="feature-item">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <span>Real-time booking notifications</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <span>Guest message alerts</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <span>Payment and sync updates</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <span>System maintenance notifications</span>
                                </div>
                            </div>
                            <div class="empty-state-actions">
                                <a href="{% url 'booking_vision_APP:channel_management' %}" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus me-2"></i>Connect Your First Channel
                                </a>
                                <a href="{% url 'booking_vision_APP:documentation' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-book me-2"></i>Learn About Activity Feed
                                </a>
                            </div>
                        </div>
                    </div>

                {% elif not user_has_properties %}
                    <!-- Has channels but no properties -->
                    <div class="empty-state-container">
                        <div class="empty-state-card properties-empty">
                            <div class="empty-state-icon">
                                <i class="fas fa-stream"></i>
                            </div>
                            <h4 class="empty-state-title">Add Properties to Generate Activities</h4>
                            <p class="empty-state-description">
                                Great! You've connected {{ connected_channels_count }} channel{{ connected_channels_count|pluralize }}. 
                                Add your rental properties to start receiving booking activities and notifications.
                            </p>
                            <div class="empty-state-progress">
                                <div class="progress-item completed">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Channels Connected</span>
                                </div>
                                <div class="progress-item current">
                                    <i class="fas fa-circle"></i>
                                    <span>Add Properties</span>
                                </div>
                                <div class="progress-item pending">
                                    <i class="far fa-circle"></i>
                                    <span>Activity Feed</span>
                                </div>
                            </div>
                            <div class="empty-state-actions">
                                <a href="{% url 'booking_vision_APP:property_create' %}" class="btn btn-success btn-lg">
                                    <i class="fas fa-home me-2"></i>Add Your First Property
                                </a>
                                <a href="{% url 'booking_vision_APP:channel_management' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-cog me-2"></i>Manage Channels
                                </a>
                            </div>
                        </div>
                    </div>

                {% else %}
                    <!-- Has channels and properties but no activities yet -->
                    <div class="empty-state-container">
                        <div class="empty-state-card activities-empty">
                            <div class="empty-state-icon">
                                <i class="fas fa-stream"></i>
                            </div>
                            <h4 class="empty-state-title">Your Activity Feed is Ready!</h4>
                            <p class="empty-state-description">
                                Perfect setup! You have {{ properties_count }} propert{{ properties_count|pluralize:"y,ies" }} 
                                and {{ connected_channels_count }} connected channel{{ connected_channels_count|pluralize }}. 
                                Activities will appear here as bookings come in and events occur.
                            </p>
                            <div class="empty-state-stats">
                                <div class="stat-item">
                                    <div class="stat-value">{{ connected_channels_count }}</div>
                                    <div class="stat-label">Connected Channels</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ properties_count }}</div>
                                    <div class="stat-label">Properties</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">Activities</div>
                                </div>
                            </div>
                            <div class="empty-state-preview">
                                <h6 class="text-muted mb-3">What you'll see here:</h6>
                                <div class="activity-preview-list">
                                    <div class="activity-preview-item">
                                        <div class="activity-preview-icon bg-success">
                                            <i class="fas fa-calendar-check"></i>
                                        </div>
                                        <div class="activity-preview-content">
                                            <strong>New Booking Received</strong>
                                            <small>When guests book your properties</small>
                                        </div>
                                    </div>
                                    <div class="activity-preview-item">
                                        <div class="activity-preview-icon bg-info">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <div class="activity-preview-content">
                                            <strong>Guest Message</strong>
                                            <small>New messages from your guests</small>
                                        </div>
                                    </div>
                                    <div class="activity-preview-item">
                                        <div class="activity-preview-icon bg-warning">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <div class="activity-preview-content">
                                            <strong>Payment Update</strong>
                                            <small>Payment confirmations and issues</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="empty-state-actions">
                                <button class="btn btn-primary btn-lg" onclick="refreshActivities()">
                                    <i class="fas fa-sync me-2"></i>Check for Activities
                                </button>
                                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#preferencesModal">
                                    <i class="fas fa-cog me-2"></i>Configure Notifications
                                </button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Preferences Modal -->
<div class="modal fade" id="preferencesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Activity Preferences
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary-blue mb-3">
                            <i class="fas fa-bell me-2"></i>Notification Settings
                        </h6>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="showPopup" 
                                   {% if preferences.show_popup %}checked{% endif %}>
                            <label class="form-check-label" for="showPopup">
                                Show popup notifications
                            </label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="playSound"
                                   {% if preferences.play_sound %}checked{% endif %}>
                            <label class="form-check-label" for="playSound">
                                Play notification sound
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="emailNotifications"
                                   {% if preferences.email_notifications %}checked{% endif %}>
                            <label class="form-check-label" for="emailNotifications">
                                Send email notifications
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Auto-refresh interval</label>
                            <select class="form-select" id="refreshInterval">
                                <option value="30" {% if preferences.refresh_interval == 30 %}selected{% endif %}>30 seconds</option>
                                <option value="60" {% if preferences.refresh_interval == 60 %}selected{% endif %}>1 minute</option>
                                <option value="300" {% if preferences.refresh_interval == 300 %}selected{% endif %}>5 minutes</option>
                                <option value="0" {% if preferences.refresh_interval == 0 %}selected{% endif %}>Manual only</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6 class="text-primary-blue mb-3">
                            <i class="fas fa-filter me-2"></i>Activity Types
                        </h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showBookings"
                                   {% if preferences.show_bookings %}checked{% endif %}>
                            <label class="form-check-label" for="showBookings">
                                <i class="fas fa-calendar-check me-2 text-success"></i>Booking activities
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showMessages"
                                   {% if preferences.show_messages %}checked{% endif %}>
                            <label class="form-check-label" for="showMessages">
                                <i class="fas fa-envelope me-2 text-info"></i>Guest messages
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showPayments"
                                   {% if preferences.show_payments %}checked{% endif %}>
                            <label class="form-check-label" for="showPayments">
                                <i class="fas fa-credit-card me-2 text-warning"></i>Payment activities
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showSystem"
                                   {% if preferences.show_system %}checked{% endif %}>
                            <label class="form-check-label" for="showSystem">
                                <i class="fas fa-cog me-2 text-secondary"></i>System notifications
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showMaintenance"
                                   {% if preferences.show_maintenance %}checked{% endif %}>
                            <label class="form-check-label" for="showMaintenance">
                                <i class="fas fa-tools me-2 text-danger"></i>Maintenance alerts
                            </label>
                        </div>
                    </div>
                </div>

                {% if activities %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Current Status:</strong> You have {{ activities|length }} activities in your feed
                            {% if stats.unread %}with {{ stats.unread }} unread{% endif %}.
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="savePreferences()">
                    <i class="fas fa-save me-2"></i>Save Preferences
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p class="mb-0">Loading activities...</p>
            </div>
        </div>
    </div>
</div>

<style>
.activity-list {
    max-height: 800px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: start;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    transition: all 0.2s;
    position: relative;
}

.activity-item:hover {
    background: #f9fafb;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item.unread {
    background: #eff6ff;
    border-left: 4px solid var(--primary-blue);
}

.activity-item.unread::before {
    content: '';
    position: absolute;
    top: 1rem;
    left: 0.5rem;
    width: 8px;
    height: 8px;
    background: var(--primary-blue);
    border-radius: 50%;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
    font-size: 1.1rem;
}

.activity-content {
    flex-grow: 1;
    min-width: 0;
}

.activity-actions {
    flex-shrink: 0;
    display: flex;
    gap: 0.25rem;
    align-items: flex-start;
}

.activity-details {
    margin-top: 0.5rem;
}

.activity-details .badge {
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
}

.stats-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: 1px solid #e5e7eb;
    text-align: center;
    transition: all 0.2s;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stats-card-muted {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.stats-card h4 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stats-card p {
    margin-bottom: 0;
    color: #6c757d;
    font-weight: 500;
}

/* Empty State Styles */
.empty-state-container {
    padding: 2rem;
    text-align: center;
}

.empty-state-card {
    max-width: 700px;
    margin: 0 auto;
    background: #f8f9fa;
    border-radius: 1rem;
    padding: 3rem 2rem;
    border: 2px dashed #dee2e6;
}

.activities-empty .empty-state-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
}

.activities-empty .empty-state-title,
.activities-empty .empty-state-description {
    color: white;
}

.empty-state-icon {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 1.5rem;
}

.channels-empty .empty-state-icon { color: var(--primary-blue); }
.properties-empty .empty-state-icon { color: #28a745; }
.activities-empty .empty-state-icon { color: white; }

.empty-state-title {
    color: #495057;
    margin-bottom: 1rem;
    font-size: 1.5rem;
    font-weight: 600;
}

.empty-state-description {
    color: #6c757d;
    margin-bottom: 2rem;
    line-height: 1.6;
    font-size: 1.1rem;
}

.empty-state-features {
    text-align: left;
    max-width: 500px;
    margin: 2rem auto;
}

.feature-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.activities-empty .feature-item {
    background: rgba(255,255,255,0.1);
    color: white;
    backdrop-filter: blur(10px);
}

.feature-item i {
    margin-right: 0.75rem;
    width: 20px;
}

.empty-state-progress {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 2rem 0;
    flex-wrap: wrap;
}

.progress-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.progress-item.completed i { color: #28a745; }
.progress-item.current i { color: #ffc107; }
.progress-item.pending i { color: #dee2e6; }

.empty-state-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 2rem 0;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
    padding: 1.5rem;
    background: rgba(255,255,255,0.1);
    border-radius: 0.75rem;
    min-width: 120px;
    backdrop-filter: blur(10px);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
}

.stat-label {
    font-size: 0.875rem;
    color: rgba(255,255,255,0.8);
    margin-top: 0.25rem;
}

.empty-state-preview {
    margin: 2rem 0;
}

.activity-preview-list {
    max-width: 500px;
    margin: 0 auto;
    text-align: left;
}

.activity-preview-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
    backdrop-filter: blur(10px);
}

.activity-preview-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: white;
}

.activity-preview-content strong {
    display: block;
    color: white;
    font-size: 0.95rem;
}

.activity-preview-content small {
    color: rgba(255,255,255,0.7);
    font-size: 0.8rem;
}

.empty-state-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 2rem;
}

.empty-state-actions .btn {
    min-width: 160px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
}

/* Compact view styles */
#compactView:checked ~ .activity-list .activity-item {
    padding: 1rem 1.5rem;
}

#compactView:checked ~ .activity-list .activity-content h6 {
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

#compactView:checked ~ .activity-list .activity-content p {
    font-size: 0.85rem;
    margin-bottom: 0;
}

#compactView:checked ~ .activity-list .activity-details {
    margin-top: 0.25rem;
}

#compactView:checked ~ .activity-list .activity-icon {
    width: 32px;
    height: 32px;
    font-size: 0.9rem;
}

/* Loading states */
.activity-item.loading {
    opacity: 0.6;
    pointer-events: none;
}

.activity-item.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
    .empty-state-container {
        padding: 1rem;
    }
    
    .empty-state-card {
        padding: 2rem 1rem;
    }
    
    .empty-state-actions {
        flex-direction: column;
        align-items: center;
    }
    
    .empty-state-actions .btn {
        width: 100%;
        max-width: 300px;
    }

    .activity-item {
        padding: 1rem;
        flex-direction: column;
        align-items: flex-start;
    }

    .activity-actions {
        margin-top: 1rem;
        width: 100%;
        justify-content: flex-end;
    }

    .stats-card h4 {
        font-size: 1.5rem;
    }

    .empty-state-stats {
        gap: 1rem;
    }

    .stat-item {
        min-width: 100px;
        padding: 1rem;
    }

    .empty-state-progress {
        gap: 1rem;
    }
}

@media (max-width: 576px) {
    .activity-icon {
        margin-right: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .activity-content {
        width: 100%;
    }

    .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 1rem;
    }

    .d-flex.justify-content-between.align-items-center.mb-4 > div {
        width: 100%;
        display: flex;
        justify-content: flex-end;
    }
}
</style>

<script>
// Enhanced WebSocket connection with reconnection
let socket;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    socket = new WebSocket(protocol + '//' + window.location.host + '/ws/activities/');
    
    socket.onopen = function(e) {
        console.log('Activity feed WebSocket connected');
        reconnectAttempts = 0;
        updateConnectionStatus(true);
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'notification') {
            handleNewActivity(data.activity);
            updateActivityBadge(data.unread_count);
            
            if ({% if preferences.show_popup %}true{% else %}false{% endif %}) {
                showActivityPopup(data.activity);
            }
            
            if ({% if preferences.play_sound %}true{% else %}false{% endif %}) {
                playNotificationSound();
            }
        }
    };

    socket.onclose = function(e) {
        console.log('Activity feed WebSocket disconnected');
        updateConnectionStatus(false);
        
        if (reconnectAttempts < maxReconnectAttempts) {
            setTimeout(() => {
                reconnectAttempts++;
                connectWebSocket();
            }, 1000 * Math.pow(2, reconnectAttempts));
        }
    };

    socket.onerror = function(e) {
        console.error('Activity feed WebSocket error:', e);
    };
}

// Initialize WebSocket connection
connectWebSocket();

function updateConnectionStatus(connected) {
    const statusIndicator = document.getElementById('connectionStatus');
    if (statusIndicator) {
        statusIndicator.className = connected ? 'text-success' : 'text-danger';
        statusIndicator.innerHTML = connected ? 
            '<i class="fas fa-circle me-1"></i>Connected' : 
            '<i class="fas fa-circle me-1"></i>Disconnected';
    }
}

function handleNewActivity(activity) {
    // Add new activity to the top of the list
    const activityList = document.getElementById('activityList');
    if (activityList && activityList.children.length > 0) {
        const newActivityHtml = createActivityHtml(activity);
        activityList.insertAdjacentHTML('afterbegin', newActivityHtml);
        
        // Animate the new activity
        const newActivity = activityList.firstElementChild;
        newActivity.style.opacity = '0';
        newActivity.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            newActivity.style.transition = 'all 0.3s ease';
            newActivity.style.opacity = '1';
            newActivity.style.transform = 'translateY(0)';
        }, 100);
        
        // Update stats if they exist
        updateActivityStats();
    } else {
        // If no activities exist, reload the page to show the first activity
        location.reload();
    }
}

function createActivityHtml(activity) {
    return `
        <div class="activity-item unread" data-activity-id="${activity.id}" data-type="${activity.type}" data-date="${activity.created_at}">
            <div class="activity-icon bg-${activity.color || 'secondary'} text-white">
                <i class="fas fa-${activity.icon || 'bell'}"></i>
            </div>
            <div class="activity-content">
                <div class="d-flex justify-content-between align-items-start">
                    <h6 class="mb-1">
                        ${activity.title}
                        ${activity.is_important ? '<span class="badge bg-warning ms-2"><i class="fas fa-exclamation-triangle me-1"></i>Important</span>' : ''}
                        <span class="badge bg-primary ms-1">New</span>
                    </h6>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>Just now
                    </small>
                </div>
                <p class="mb-1 text-muted">${activity.description}</p>
            </div>
            <div class="activity-actions">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="markAsRead(${activity.id})" title="Mark as read">
                    <i class="fas fa-check"></i>
                </button>
                ${activity.action_url ? `<a href="${activity.action_url}" class="btn btn-sm btn-outline-secondary" title="View details"><i class="fas fa-external-link-alt"></i></a>` : ''}
            </div>
        </div>
    `;
}

function markAsRead(activityId) {
    const activityElement = document.querySelector(`[data-activity-id="${activityId}"]`);
    if (activityElement) {
        activityElement.classList.add('loading');
    }
    
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            'action': 'mark_read',
            'activity_id': activityId
        }));
    } else {
        // Fallback to AJAX if WebSocket is not available
        fetch('{% url "booking_vision_APP:activity_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                action: 'mark_read',
                activity_id: activityId
            })
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                updateActivityUI(activityId, 'read');
            }
        });
    }
    
    // Update UI immediately for better UX
    updateActivityUI(activityId, 'read');
}

function updateActivityUI(activityId, action) {
    const activityElement = document.querySelector(`[data-activity-id="${activityId}"]`);
    if (activityElement) {
        activityElement.classList.remove('loading');
        
        if (action === 'read') {
            activityElement.classList.remove('unread');
            const newBadge = activityElement.querySelector('.badge.bg-primary');
            if (newBadge) {
                newBadge.remove();
            }
            const markReadBtn = activityElement.querySelector('.btn-outline-primary');
            if (markReadBtn) {
                markReadBtn.remove();
            }
        }
    }
}

function markAllAsRead() {
    const unreadActivities = document.querySelectorAll('.activity-item.unread');
    if (unreadActivities.length === 0) return;
    
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            'action': 'mark_all_read'
        }));
    }
    
    // Update UI immediately
    unreadActivities.forEach(item => {
        item.classList.remove('unread');
        const newBadge = item.querySelector('.badge.bg-primary');
        if (newBadge) newBadge.remove();
        const markReadBtn = item.querySelector('.btn-outline-primary');
        if (markReadBtn) markReadBtn.remove();
    });
    
    updateActivityBadge(0);
    updateActivityStats();
    
    // Disable the mark all read button
    const markAllBtn = document.querySelector('button[onclick="markAllAsRead()"]');
    if (markAllBtn) {
        markAllBtn.disabled = true;
        markAllBtn.innerHTML = '<i class="fas fa-check-double me-2"></i>All Read';
    }
}

function markImportant(activityId) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            'action': 'mark_important',
            'activity_id': activityId
        }));
    }
    
    const activityElement = document.querySelector(`[data-activity-id="${activityId}"]`);
    if (activityElement) {
        const titleElement = activityElement.querySelector('h6');
        if (titleElement && !titleElement.querySelector('.badge.bg-warning')) {
            titleElement.insertAdjacentHTML('beforeend', 
                '<span class="badge bg-warning ms-2"><i class="fas fa-exclamation-triangle me-1"></i>Important</span>'
            );
        }
    }
}

function archiveActivity(activityId) {
    if (confirm('Archive this activity? It will be moved to your archived activities.')) {
        const activityElement = document.querySelector(`[data-activity-id="${activityId}"]`);
        if (activityElement) {
            activityElement.style.transition = 'all 0.3s ease';
            activityElement.style.opacity = '0';
            activityElement.style.transform = 'translateX(-100%)';
            
            setTimeout(() => {
                activityElement.remove();
                updateActivityStats();
            }, 300);
        }
        
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                'action': 'archive',
                'activity_id': activityId
            }));
        }
    }
}

function deleteActivity(activityId) {
    if (confirm('Delete this activity permanently? This action cannot be undone.')) {
        const activityElement = document.querySelector(`[data-activity-id="${activityId}"]`);
        if (activityElement) {
            activityElement.style.transition = 'all 0.3s ease';
            activityElement.style.opacity = '0';
            activityElement.style.transform = 'scale(0.8)';
            
            setTimeout(() => {
                activityElement.remove();
                updateActivityStats();
                checkIfEmpty();
            }, 300);
        }
        
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                'action': 'delete',
                'activity_id': activityId
            }));
        }
    }
}

function updateActivityStats() {
    const activities = document.querySelectorAll('.activity-item');
    const unreadActivities = document.querySelectorAll('.activity-item.unread');
    const importantActivities = document.querySelectorAll('.activity-item .badge.bg-warning');
    
    // Update stats cards if they exist
    const statsCards = document.querySelectorAll('.stats-card h4');
    if (statsCards.length >= 4) {
        statsCards[0].textContent = unreadActivities.length;
        statsCards[0].className = unreadActivities.length > 0 ? 'text-primary' : 'text-muted';
        
        statsCards[1].textContent = importantActivities.length;
        statsCards[1].className = importantActivities.length > 0 ? 'text-warning' : 'text-muted';
        
        statsCards[3].textContent = activities.length;
    }
}

function checkIfEmpty() {
    const activityList = document.getElementById('activityList');
    if (activityList && activityList.children.length === 0) {
        // Show empty state
        location.reload();
    }
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    const activities = document.querySelectorAll('.activity-item');
    let visibleCount = 0;
    
    activities.forEach(activity => {
        let visible = true;
        
        // Status filter
        if (statusFilter === 'unread' && !activity.classList.contains('unread')) {
            visible = false;
        } else if (statusFilter === 'important' && !activity.querySelector('.badge.bg-warning')) {
            visible = false;
        }
        
        // Type filter
        if (typeFilter && activity.dataset.type !== typeFilter) {
            visible = false;
        }
        
        // Date filter
        if (dateFilter === 'today') {
            const today = new Date().toISOString().split('T')[0];
            if (activity.dataset.date !== today) {
                visible = false;
            }
        }
        
        activity.style.display = visible ? 'flex' : 'none';
        if (visible) visibleCount++;
    });
    
    // Show filter results
    showFilterResults(visibleCount);
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('dateFilter').value = '';
    
    const activities = document.querySelectorAll('.activity-item');
    activities.forEach(activity => {
        activity.style.display = 'flex';
    });
    
    hideFilterResults();
}

function showFilterResults(count) {
    let resultDiv = document.getElementById('filterResults');
    if (!resultDiv) {
        resultDiv = document.createElement('div');
        resultDiv.id = 'filterResults';
        resultDiv.className = 'alert alert-info mt-3';
        document.querySelector('.card-body').insertBefore(resultDiv, document.getElementById('activityList'));
    }
    
    resultDiv.innerHTML = `
        <i class="fas fa-filter me-2"></i>
        Showing ${count} filtered activit${count !== 1 ? 'ies' : 'y'}
        <button type="button" class="btn-close float-end" onclick="clearFilters()"></button>
    `;
}

function hideFilterResults() {
    const resultDiv = document.getElementById('filterResults');
    if (resultDiv) {
        resultDiv.remove();
    }
}

function refreshActivities() {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function exportActivities() {
    const activities = document.querySelectorAll('.activity-item[style*="flex"], .activity-item:not([style])');
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Date,Title,Description,Type,Status\n"
        + Array.from(activities).map(activity => {
            const title = activity.querySelector('h6').textContent.trim();
            const description = activity.querySelector('p').textContent.trim();
            const type = activity.dataset.type || 'Unknown';
            const status = activity.classList.contains('unread') ? 'Unread' : 'Read';
            const date = activity.dataset.date || new Date().toISOString().split('T')[0];
            
            return `"${date}","${title}","${description}","${type}","${status}"`;
        }).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `booking_vision_activities_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    BookingVision.showNotification('Activities exported successfully!', 'success');
}

function loadMoreActivities() {
    // Implementation for pagination
    const currentPage = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;
    const nextPage = currentPage + 1;
    
    window.location.href = `${window.location.pathname}?page=${nextPage}`;
}

function savePreferences() {
    const preferences = {
        show_popup: document.getElementById('showPopup').checked,
        play_sound: document.getElementById('playSound').checked,
        email_notifications: document.getElementById('emailNotifications').checked,
        refresh_interval: parseInt(document.getElementById('refreshInterval').value),
        show_bookings: document.getElementById('showBookings').checked,
        show_messages: document.getElementById('showMessages').checked,
        show_payments: document.getElementById('showPayments').checked,
        show_system: document.getElementById('showSystem').checked,
        show_maintenance: document.getElementById('showMaintenance').checked
    };
    
    fetch('{% url "booking_vision_APP:activity_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            action: 'update_preferences',
            preferences: preferences
        })
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('preferencesModal')).hide();
            BookingVision.showNotification('Preferences saved successfully!', 'success');
            
            // Update auto-refresh if needed
            if (preferences.refresh_interval > 0) {
                setupAutoRefresh(preferences.refresh_interval);
            }
        } else {
            BookingVision.showNotification('Failed to save preferences', 'error');
        }
    }).catch(error => {
        BookingVision.showNotification('Error saving preferences', 'error');
    });
}

function setupAutoRefresh(interval) {
    // Clear existing interval
    if (window.activityRefreshInterval) {
        clearInterval(window.activityRefreshInterval);
    }
    
    if (interval > 0) {
        window.activityRefreshInterval = setInterval(() => {
            if (document.visibilityState === 'visible') {
                refreshActivities();
            }
        }, interval * 1000);
    }
}

function showActivityPopup(activity) {
    if (Notification.permission === 'granted') {
        new Notification(activity.title, {
            body: activity.description,
            icon: '/static/images/logo-small.png',
            tag: 'booking-vision-activity'
        });
    } else if (Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showActivityPopup(activity);
            }
        });
    }
}

function playNotificationSound() {
    const audio = new Audio('/static/sounds/notification.mp3');
    audio.volume = 0.5;
    audio.play().catch(() => {
        // Ignore audio play errors (e.g., autoplay policy)
    });
}

// Setup auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if preferences.refresh_interval %}
    setupAutoRefresh({{ preferences.refresh_interval }});
    {% endif %}
    
    // Request notification permission if not already granted
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

// View mode toggle
document.addEventListener('change', function(e) {
    if (e.target.name === 'viewMode') {
        const activityList = document.getElementById('activityList');
        if (activityList) {
            activityList.className = e.target.id === 'compactView' ? 
                'activity-list compact-view' : 'activity-list';
        }
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (socket) {
        socket.close();
    }
    if (window.activityRefreshInterval) {
        clearInterval(window.activityRefreshInterval);
    }
});
</script>
{% endblock %}