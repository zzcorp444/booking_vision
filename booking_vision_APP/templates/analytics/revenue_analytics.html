{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Revenue Analytics - Booking Vision{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<style>
    .analytics-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
    }
    
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        border-left: 4px solid #667eea;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .growth-indicator {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-top: 0.5rem;
    }
    
    .growth-positive {
        background: #d4edda;
        color: #155724;
    }
    
    .growth-negative {
        background: #f8d7da;
        color: #721c24;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
    }
    
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .performance-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .table-header {
        background: #667eea;
        color: white;
        padding: 1rem;
        font-weight: 600;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .empty-state-icon {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    .seasonal-card {
        background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        color: #2d3436;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .channel-performance {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #00b894;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="analytics-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-chart-line me-3"></i>
                        Revenue Analytics
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">
                        Comprehensive revenue insights and performance metrics
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex flex-column align-items-end">
                        <span class="small opacity-75">Period</span>
                        <strong>{{ start_date|date:"M j, Y" }} - {{ end_date|date:"M j, Y" }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not has_data %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-chart-line-down"></i>
            </div>
            <h3>No Revenue Data Available</h3>
            <p class="text-muted mb-4">
                You don't have any completed bookings or payments yet. Start by adding your properties and managing bookings to see detailed revenue analytics.
            </p>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="fas fa-home text-primary mb-3" style="font-size: 2rem;"></i>
                                    <h5>Add Properties</h5>
                                    <p class="text-muted small">Add your rental properties to start tracking revenue</p>
                                    <a href="{% url 'property_create' %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i>Add Property
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-plus text-success mb-3" style="font-size: 2rem;"></i>
                                    <h5>Create Bookings</h5>
                                    <p class="text-muted small">Add bookings to start generating revenue data</p>
                                    <a href="{% url 'booking_create' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-plus me-1"></i>Add Booking
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Date Filter -->
        <div class="filter-section">
            <form method="GET" class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <label class="me-3 mb-0">
                        <i class="fas fa-calendar me-2"></i>
                        <strong>Time Period:</strong>
                    </label>
                    <select name="date_range" class="form-select" style="width: auto;" onchange="this.form.submit()">
                        <option value="30_days" {% if date_range == '30_days' %}selected{% endif %}>Last 30 Days</option>
                        <option value="90_days" {% if date_range == '90_days' %}selected{% endif %}>Last 90 Days</option>
                        <option value="6_months" {% if date_range == '6_months' %}selected{% endif %}>Last 6 Months</option>
                        <option value="12_months" {% if date_range == '12_months' %}selected{% endif %}>Last 12 Months</option>
                    </select>
                </div>
                <div class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Data updated in real-time
                </div>
            </form>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-value">${{ total_revenue|floatformat:2 }}</div>
                    <div class="metric-label">Total Revenue</div>
                    {% if revenue_growth != 0 %}
                        <div class="growth-indicator {% if revenue_growth > 0 %}growth-positive{% else %}growth-negative{% endif %}">
                            <i class="fas fa-arrow-{% if revenue_growth > 0 %}up{% else %}down{% endif %} me-1"></i>
                            {{ revenue_growth|floatformat:1 }}%
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-value">{{ total_bookings }}</div>
                    <div class="metric-label">Total Bookings</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-value">${{ avg_booking_value|floatformat:2 }}</div>
                    <div class="metric-label">Avg Booking Value</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card">
                    <div class="metric-value">{{ occupancy_rate }}%</div>
                    <div class="metric-label">Occupancy Rate</div>
                </div>
            </div>
        </div>

        <!-- Advanced Metrics -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="metric-card">
                    <div class="metric-value">${{ adr|floatformat:2 }}</div>
                    <div class="metric-label">Average Daily Rate (ADR)</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="metric-card">
                    <div class="metric-value">${{ revpar|floatformat:2 }}</div>
                    <div class="metric-label">Revenue per Available Room (RevPAR)</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="metric-card">
                    <div class="metric-value">{{ total_nights }}</div>
                    <div class="metric-label">Total Nights Booked</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="chart-container">
                    <div class="chart-title">Monthly Revenue Trend</div>
                    <canvas id="monthlyRevenueChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container">
                    <div class="chart-title">Revenue by Source</div>
                    <canvas id="revenueSourceChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Seasonal Analysis -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">Seasonal Performance</div>
                    <canvas id="seasonalChart" height="150"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">Top Performing Months</div>
                    {% for month in top_months %}
                        <div class="seasonal-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ month.month_name }}</h6>
                                    <small>{{ month.bookings }} bookings</small>
                                </div>
                                <div class="text-end">
                                    <strong style="font-size: 1.2rem;">${{ month.revenue|floatformat:2 }}</strong>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Performance Tables -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="performance-table">
                    <div class="table-header">
                        <i class="fas fa-home me-2"></i>
                        Property Performance
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>Revenue</th>
                                    <th>Bookings</th>
                                    <th>Avg Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prop in property_performance %}
                                <tr>
                                    <td>
                                        <strong>{{ prop.property.name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ prop.nights }} nights</small>
                                    </td>
                                    <td><strong>${{ prop.revenue|floatformat:2 }}</strong></td>
                                    <td>{{ prop.bookings }}</td>
                                    <td>${{ prop.avg_rate|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="performance-table">
                    <div class="table-header">
                        <i class="fas fa-chart-pie me-2"></i>
                        Channel Performance
                    </div>
                    <div class="p-3">
                        {% for channel, data in channel_performance.items %}
                            <div class="channel-performance">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">{{ channel }}</h6>
                                    <strong>${{ data.revenue|floatformat:2 }}</strong>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">{{ data.bookings }} bookings</small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">{{ data.nights }} nights</small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Insights -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-lightbulb me-2"></i>
                        Revenue Insights
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-trend-up me-2"></i>Growth Trend</h6>
                                <p class="mb-0">
                                    Revenue {% if revenue_growth > 0 %}increased{% else %}decreased{% endif %} by 
                                    <strong>{{ revenue_growth|floatformat:1 }}%</strong> compared to the previous period.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-star me-2"></i>Best Performance</h6>
                                <p class="mb-0">
                                    <strong>{{ top_months.0.month_name }}</strong> was your best month with 
                                    <strong>${{ top_months.0.revenue|floatformat:2 }}</strong> in revenue.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-chart-bar me-2"></i>Occupancy Rate</h6>
                                <p class="mb-0">
                                    Your occupancy rate of <strong>{{ occupancy_rate }}%</strong> 
                                    {% if occupancy_rate > 70 %}is excellent{% elif occupancy_rate > 50 %}is good{% else %}could be improved{% endif %}.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% if has_data %}
<script>
    // Monthly Revenue Chart
    const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    const monthlyRevenueData = {{ monthly_revenue|safe }};
    
    new Chart(monthlyRevenueCtx, {
        type: 'line',
        data: {
            labels: monthlyRevenueData.map(item => item.month_name),
            datasets: [{
                label: 'Revenue',
                data: monthlyRevenueData.map(item => item.revenue),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Revenue Source Chart
    const revenueSourceCtx = document.getElementById('revenueSourceChart').getContext('2d');
    const revenueSourceData = {{ revenue_by_source|safe }};
    
    new Chart(revenueSourceCtx, {
        type: 'doughnut',
        data: {
            labels: revenueSourceData.map(item => item.channel),
            datasets: [{
                data: revenueSourceData.map(item => item.revenue),
                backgroundColor: [
                    '#667eea',
                    '#764ba2',
                    '#f093fb',
                    '#f5576c',
                    '#4facfe',
                    '#43e97b'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Seasonal Chart
    const seasonalCtx = document.getElementById('seasonalChart').getContext('2d');
    const seasonalData = {{ seasonal_data|safe }};
    
    new Chart(seasonalCtx, {
        type: 'bar',
        data: {
            labels: seasonalData.map(item => item.season),
            datasets: [{
                label: 'Revenue',
                data: seasonalData.map(item => item.revenue),
                backgroundColor: ['#ffeaa7', '#fab1a0', '#fd79a8', '#a29bfe']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}