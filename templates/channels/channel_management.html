<!-- booking_vision_APP/templates/channels/channel_management.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Channel Management - Booking Vision{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4 text-primary-blue">
                <i class="fas fa-link me-2"></i>Channel Management (No API Required)
            </h1>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No API Keys Needed!</strong> We use multiple sync methods to connect with your channels.
            </div>
        </div>
    </div>
    
    <div class="row">
        {% for channel in channels %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card channel-card">
                <div class="card-header d-flex align-items-center">
                    <img src="{% static 'images/channel_logos/'|add:channel.name|lower|add:'_logo.png' %}" 
                        alt="{{ channel.name }}" 
                        class="channel-logo me-3"
                        onerror="this.style.display='none'">
                    <h5 class="mb-0">{{ channel.name }}</h5>
                </div>
                <div class="card-body">
                    {% if channel.id in connected_channels %}
                        <div class="text-center mb-3">
                            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                            <p class="text-success">Connected</p>
                            
                            <!-- Sync method indicator -->
                            <div class="mb-3">
                                <small class="text-muted">Last sync via:</small>
                                <span class="badge bg-info">
                                    {{ connected_channels|get_item:channel.id.last_sync_method|default:"Not synced yet" }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="syncChannel({{ channel.id }})">
                                <i class="fas fa-sync me-2"></i>Sync Now
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="configureSync({{ channel.id }}, '{{ channel.name }}')">
                                <i class="fas fa-cog me-2"></i>Configure
                            </button>
                        </div>
                    {% else %}
                        <div class="text-center mb-3">
                            <i class="fas fa-times-circle text-muted fa-3x mb-3"></i>
                            <p class="text-muted">Not Connected</p>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="connectChannel({{ channel.id }}, '{{ channel.name }}')">
                                <i class="fas fa-link me-2"></i>Connect
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Browser Extension Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-puzzle-piece me-2"></i>Browser Extension
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6>Booking Vision Browser Extension</h6>
                            <p class="text-muted mb-2">
                                Install our browser extension for automatic booking capture while you browse OTA websites.
                            </p>
                            <p class="mb-0">
                                <span class="badge bg-success me-2">Chrome</span>
                                <span class="badge bg-success me-2">Firefox</span>
                                <span class="badge bg-success">Edge</span>
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <button class="btn btn-primary" onclick="installExtension()">
                                <i class="fas fa-download me-2"></i>Install Extension
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">Extension Token:</small>
                                <code id="extensionToken">Loading...</code>
                                <button class="btn btn-sm btn-link" onclick="copyToken()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Modal -->
<div class="modal fade" id="connectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Connect to <span id="channelName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="channelId">
                
                <!-- Sync Method Selection -->
                <div class="mb-4">
                    <h6>Choose Sync Method:</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check sync-method-card">
                                <input class="form-check-input" type="radio" name="syncMethod" 
                                       id="icalMethod" value="ical" checked>
                                <label class="form-check-label w-100" for="icalMethod">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt fa-2x text-primary me-3"></i>
                                        <div>
                                            <strong>iCal Feed</strong>
                                            <br><small class="text-muted">Sync availability using calendar feed</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check sync-method-card">
                                <input class="form-check-input" type="radio" name="syncMethod" 
                                       id="emailMethod" value="email">
                                <label class="form-check-label w-100" for="emailMethod">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-envelope fa-2x text-info me-3"></i>
                                        <div>
                                            <strong>Email Parsing</strong>
                                            <br><small class="text-muted">Parse booking confirmation emails</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check sync-method-card">
                                <input class="form-check-input" type="radio" name="syncMethod" 
                                       id="scrapingMethod" value="scraping">
                                <label class="form-check-label w-100" for="scrapingMethod">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-robot fa-2x text-warning me-3"></i>
                                        <div>
                                            <strong>Web Scraping</strong>
                                            <br><small class="text-muted">Automated data extraction</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check sync-method-card">
                                <input class="form-check-input" type="radio" name="syncMethod" 
                                       id="extensionMethod" value="extension">
                                <label class="form-check-label w-100" for="extensionMethod">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-puzzle-piece fa-2x text-success me-3"></i>
                                        <div>
                                            <strong>Browser Extension</strong>
                                            <br><small class="text-muted">Capture data while browsing</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Method-specific forms -->
                <div id="methodForms">
                    <!-- iCal Form -->
                    <div id="icalForm" class="method-form">
                        <h6>iCal Configuration</h6>
                        <div class="mb-3">
                            <label class="form-label">iCal Feed URL</label>
                            <input type="url" class="form-control" id="icalUrl" 
                                   placeholder="https://example.com/calendar.ics">
                            <small class="text-muted">
                                Find this in your channel's calendar sync settings
                            </small>
                        </div>
                    </div>
                    
                    <!-- Email Form -->
                    <div id="emailForm" class="method-form" style="display: none;">
                        <h6>Email Configuration</h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            You'll need to set up an app-specific password for email access
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email Provider</label>
                            <select class="form-select" id="emailProvider">
                                <option value="gmail">Gmail</option>
                                <option value="outlook">Outlook</option>
                                <option value="yahoo">Yahoo</option>
                                <option value="custom">Custom IMAP</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Scraping Form -->
                    <div id="scrapingForm" class="method-form" style="display: none;">
                        <h6>Web Scraping Configuration</h6>
                        <div class="mb-3">
                            <label class="form-label">Channel Login Email</label>
                            <input type="email" class="form-control" id="scrapingEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Channel Password</label>
                            <input type="password" class="form-control" id="scrapingPassword">
                            <small class="text-muted">
                                Your credentials are encrypted and only used for automated sync
                            </small>
                        </div>
                    </div>
                    
                    <!-- Extension Form -->
                    <div id="extensionForm" class="method-form" style="display: none;">
                        <h6>Browser Extension Setup</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Make sure you have installed and configured the Booking Vision browser extension
                        </div>
                        <ol>
                            <li>Install the browser extension</li>
                            <li>Log in to your channel accounts in the browser</li>
                            <li>The extension will automatically capture bookings</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitConnection()">
                    <i class="fas fa-save me-2"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.sync-method-card {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.sync-method-card:hover {
    border-color: var(--primary-blue);
    background-color: #f0f9ff;
}

.form-check-input:checked ~ .sync-method-card {
    border-color: var(--primary-blue);
    background-color: #eff6ff;
}

.method-form {
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
}
</style>

<script>
// Load extension token
document.addEventListener('DOMContentLoaded', function() {
    fetch('{% url "booking_vision_APP:get_extension_token" %}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('extensionToken').textContent = data.token;
        });
});

// Copy token to clipboard
function copyToken() {
    const token = document.getElementById('extensionToken').textContent;
    navigator.clipboard.writeText(token);
    BookingVision.showNotification('Token copied to clipboard!', 'success');
}

// Install extension
function installExtension() {
    // Detect browser
    const isChrome = /Chrome/.test(navigator.userAgent);
    const isFirefox = /Firefox/.test(navigator.userAgent);
    const isEdge = /Edg/.test(navigator.userAgent);
    
    let extensionUrl;
    if (isChrome) {
        extensionUrl = 'https://chrome.google.com/webstore/detail/booking-vision/[extension-id]';
    } else if (isFirefox) {
        extensionUrl = 'https://addons.mozilla.org/firefox/addon/booking-vision/';
    } else if (isEdge) {
        extensionUrl = 'https://microsoftedge.microsoft.com/addons/detail/booking-vision/[extension-id]';
    }
    
    if (extensionUrl) {
        window.open(extensionUrl, '_blank');
    } else {
        alert('Please use Chrome, Firefox, or Edge browser');
    }
}

// Handle sync method selection
document.querySelectorAll('input[name="syncMethod"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // Hide all forms
        document.querySelectorAll('.method-form').forEach(form => {
            form.style.display = 'none';
        });
        
        // Show selected form
        const formId = this.value + 'Form';
        const form = document.getElementById(formId);
        if (form) {
            form.style.display = 'block';
        }
    });
});

function connectChannel(channelId, channelName) {
    document.getElementById('channelId').value = channelId;
    document.getElementById('channelName').textContent = channelName;
    new bootstrap.Modal(document.getElementById('connectionModal')).show();
}

function configureSync(channelId, channelName) {
    // Load existing configuration
    connectChannel(channelId, channelName);
}

function submitConnection() {
    const channelId = document.getElementById('channelId').value;
    const syncMethod = document.querySelector('input[name="syncMethod"]:checked').value;
    
    let configData = {
        channel_id: channelId,
        sync_method: syncMethod
    };
    
    // Get method-specific data
    switch (syncMethod) {
        case 'ical':
            configData.ical_url = document.getElementById('icalUrl').value;
            break;
        case 'email':
            configData.email_provider = document.getElementById('emailProvider').value;
            break;
        case 'scraping':
            configData.login_email = document.getElementById('scrapingEmail').value;
            configData.login_password = document.getElementById('scrapingPassword').value;
            break;
    }
    
    fetch('{% url "booking_vision_APP:connect_channel" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            BookingVision.showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            BookingVision.showNotification('Error: ' + data.error, 'error');
        }
    });
}

function syncChannel(channelId) {
    BookingVision.showNotification('Starting sync...', 'info');
    
    fetch('{% url "booking_vision_APP:sync_bookings" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            channel_id: channelId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            BookingVision.showNotification('Sync completed successfully!', 'success');
        } else {
            BookingVision.showNotification('Sync failed: ' + data.error, 'error');
        }
    });
}
</script>
{% endblock %}